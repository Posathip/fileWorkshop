<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes Prediction TF.js Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }

        #form-container {
            display: none;
            margin-top: 20px;
        }

        input {
            width: 80px;
            margin: 5px;
        }

        button {
            margin-top: 10px;
        }

        .container {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 350px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #loading {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        #form-container {
            display: none;
        }

        label {
            display: inline-block;
            width: 140px;
            margin-bottom: 5px;
        }

        input[type=number] {
            width: 150px;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }

        #result {
            text-align: center;
            font-weight: bold;
            margin-top: 15px;
        }
    </style>
</head>

<body>

    <h2>Diabetes Prediction</h2>

    <div id="loading">Loading and training model, please wait...</div>

    <div id="form-container">
    <p>กรอกข้อมูลผู้ป่วย:</p>
    <label>ระดับน้ำตาลในเลือด (Glucose):</label><input type="number" id="glucose"><br>
    <label>ความดันโลหิต (BloodPressure):</label><input type="number" id="bp"><br>
    <label>ความหนาผิวหนัง (SkinThickness):</label><input type="number" id="skin"><br>
    <label>ระดับอินซูลิน (Insulin):</label><input type="number" id="insulin"><br>
    <label>ค่าดัชนีมวลกาย (BMI):</label><input type="number" step="0.1" id="bmi"><br>
    <label>ค่าความเสี่ยงทางพันธุกรรมต่อเบาหวาน (DiabetesPedigree):</label>
    <input type="number" step="0.01" id="dp"><br>
    <label>อายุ (Age):</label><input type="number" id="age"><br>
    <label>เพศ (0=หญิง, 1=ชาย):</label><input type="number" id="sex"><br>
    <button onclick="predictDiabetes()">ทำนายผล</button>
    <p id="result"></p>
</div>


    <script>
        let model;


async function loadData() {
    const csvUrl = 'transactions.csv'; 
    const rawData = tf.data.csv(csvUrl, {
        columnConfigs: { Outcome: { isLabel: true } }
    });

    const numOfFeatures = (await rawData.columnNames()).length - 1;

    const convertedData = rawData.map(({xs, ys}) => {
        const features = [
            xs.Glucose, xs.BloodPressure, xs.SkinThickness, xs.Insulin,
            xs.BMI, xs.DiabetesPedigree, xs.Age, xs.Sex
        ];
        return { xs: features, ys: [ys.Outcome] };
    }).batch(10);

    return { dataset: convertedData, numOfFeatures };
}


async function trainModel() {
    const { dataset, numOfFeatures } = await loadData();

    model = tf.sequential();

    
    model.add(tf.layers.dense({ inputShape: [numOfFeatures], units: 32, activation: 'relu' }));
    model.add(tf.layers.dense({ units: 16, activation: 'relu' }));
    model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
    model.add(tf.layers.dense({ units: 1, activation: 'sigmoid' }));

    model.compile({
        loss: 'binaryCrossentropy',
        optimizer: tf.train.adam(0.001), 
        metrics: ['accuracy']
    });

    const history = await model.fitDataset(dataset, {
        epochs: 50,      
        shuffle: true,
        callbacks: {
            onEpochEnd: (epoch, logs) => {
                console.log(`Epoch ${epoch + 1}: loss=${logs.loss.toFixed(4)}, acc=${logs.acc.toFixed(4)}`);
                document.getElementById('loading').innerText = 
                    `Training model... Epoch ${epoch + 1} Loss: ${logs.loss.toFixed(4)} Accuracy: ${logs.acc.toFixed(4)}`;
            }
        }
    });

    console.log(" Training complete!");
    document.getElementById('loading').style.display = 'none';
    document.getElementById('form-container').style.display = 'block';


    await model.fitDataset(dataset, {
        epochs: 50,
        callbacks: {
            onEpochEnd: (epoch, logs) => {
                document.getElementById('loading').innerText =
                    `Training model... Epoch ${epoch+1}, Loss: ${logs.loss.toFixed(4)}, Accuracy: ${logs.acc.toFixed(4)}`;
            }
        }
    });

    document.getElementById('loading').style.display = 'none';
    document.getElementById('form-container').style.display = 'block';
}


async function predictDiabetes() {
    const inputValues = [
        parseFloat(document.getElementById('glucose').value),
        parseFloat(document.getElementById('bp').value),
        parseFloat(document.getElementById('skin').value),
        parseFloat(document.getElementById('insulin').value),
        parseFloat(document.getElementById('bmi').value),
        parseFloat(document.getElementById('dp').value),
        parseFloat(document.getElementById('age').value),
        parseFloat(document.getElementById('sex').value)
    ];

    if (inputValues.some(isNaN)) {
        alert("Please enter all fields");
        return;
    }

    const inputTensor = tf.tensor2d([inputValues]);
    const prediction = model.predict(inputTensor);
    const predValue = (await prediction.data())[0];

    document.getElementById('result').innerText =
        "Predicted Outcome: " + (predValue >= 0.5 ? "Diabetes (1)" : "No Diabetes (0)") + ` (Probability: ${predValue.toFixed(2)})`;
}


trainModel();
    </script>

</body>

</html>